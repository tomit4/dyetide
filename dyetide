#!/usr/bin/env bash
# set -vx

printhelp() {
    cat <<EOM
usage: dyeit [-x|-r] file
options:
 -x             replace all hex with rgba in file
 -r             replace all rgb with hex in file
examples:
 dyeit -x file
 dyeit -r file
EOM
    exit 1
}

error() {
    printf "error: %s\n" "$1" 1>&2
    ${2:+exit $2}
}

dependencycheck() {
    local dep missingdependencies=0
    for dep in "$@"; do
        if ! command -v "$dep" &>/dev/null; then
            error "dependency not met: $dep"
        fi
    done
    if [[ $missingdependencies -gt 0 ]]; then
        exit 1
    fi
}

# search/replace all hex color codes with rgb codes
replace_all_hex() {
    filename="${2}"
    if [[ -f "$filename" ]]; then
        local allhexvalues hexvalues=()
        mapfile -t allhexvalues < \
            <( grep -P -o '#[0-9a-fA-F]{8}|#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}' "${filename}" )
            while IFS= read -r -d '' x; do
                hexvalues+=("$x");
            done < \
                <(printf "%s\0" "${allhexvalues[@]}" | sort -uz)
        for hex in "${hexvalues[@]}"; do
            rgb=$(./dependencies/repaint -x "$hex" )
            sed -E "s/\s${hex}\s/ ${rgb} /g" < "$filename" | sponge "$filename"
            sed -E "s/\s${hex};/ ${rgb};/g" < "$filename" | sponge "$filename"
        done
    fi
}

# searches through all intances of rgb/rgba color codes and replaces
# them with hex codes
# replace_all_rgb() {

# }

main() {
    if [[ "$#" -lt 1 ]]; then
        printhelp
    fi

    while getopts ":x:r:?" arg; do
        case $arg in
            x)
                replace_all_hex "$@"
                ;;
            r)
                # replace_all_rgb "$@"
                printhelp
                ;;
            ?)
                printhelp
                ;;
        esac
    done
}

main "$@"
