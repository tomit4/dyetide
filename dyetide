#!/usr/bin/env bash
# set -vx

printhelp() {
    cat <<EOM
usage: dyetide [-x|-r] file
options:
 -x             replace all hex with rgba in file
 -r             replace all rgb with hex in file
examples:
 dyetide -x file
 dyetide -r file
EOM
    exit 0
}

error() {
    printf "error: %s\n" "$1" 1>&2
    exit 1
}

success() {
    printf "success: %s\n" "$1" 2>&1
    exit 0
}

replace_all_hex() {
    local filename
    filename="${3}"
    if [[ -f "$filename" ]]; then
        local regex hexvalues=()
        regex='#[0-9a-fA-F]{8}|#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3}'
        mapfile -t hexvalues < <(grep -P -o "${regex}" "${filename}" | sort -r -k1.1 | sort -u)
        if [[ ${#hexvalues[@]} -eq 0 ]]; then
            error "no hex values found in $filename"
        fi
        for hex in "${hexvalues[@]}"; do
            local rgb
            rgb=$(dye -x rgb "$hex")
            sed -i "s/${hex}\([^0-9a-fA-F]\|$\)/${rgb}\1/g" "$filename"
        done
        success "${filename}'s hex codes converted to rgba"
    else
        error "$filename not found"
    fi
}

replace_all_rgb() {
    local filename
    filename="${3}"
    if [[ -f "$filename" ]]; then
        local allrgbvalues rgbvalues rgbarr
        IFS=$'\n'
        regex='\s?rgb[a]?[(][0-9]{1,3}, [0-9]{1,3}, [0-9]{1,3}[)]|rgb[a]?[(][0-9]{1,3}, [0-9]{1,3}, [0-9]{1,3}, [0-1]?.[0-9][0-9]?[)]\s?'
        allrgbvalues=$(grep -Po "${regex}" "${filename}")

        read -d '' -r -a rgbarr <<< "${allrgbvalues}"

        if [[ ${#rgbarr[@]} -eq 0 ]]; then
            error "no rgb values found in $filename"
        fi

        while IFS= read -r -d '' x; do
            rgbvalues+=("$x")
        done < <(printf "%s\0" "${rgbarr[@]}" | sort -uz)

        for rgb in "${rgbvalues[@]}"; do
            local hex
            hex=$(dye -r hex "$rgb")
            sed -i "s/${rgb}\([^0-9]\|$\)/ ${hex}\1/g" "$filename"
        done

        success "${filename}'s rgba codes converted to hex"
    else
        error "$filename not found"
    fi
}

main() {
    [[ "$#" -lt 1 ]] && printhelp

    while getopts ":x:r:?" arg; do
        case $arg in
            x)
                replace_all_hex "$@"
                ;;
            r)
                replace_all_rgb "$@"
                ;;
            ?)
                printhelp
                ;;
        esac
    done
}

main "$@"

# https://unix.stackexchange.com/questions/482393/bash-sort-array-according-to-length-of-elements
